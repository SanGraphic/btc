<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes"> <!-- Updated from apple-mobile-web-app-capable -->
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">
    <title>BTC Price Chart</title>
    
    <!-- iOS web app icons -->
    <link rel="apple-touch-icon" href="icon-180.png">
    <link rel="apple-touch-startup-image" href="splash.png">
    
    <!-- Add required dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Link to manifest file -->
    <link rel="manifest" href="/btc/manifest.json">
    
    <script src="/btc/service-worker.js"></script>
    
    <style>
        /* iOS System Font */
        @font-face {
            font-family: 'SF Pro Text';
            src: local('-apple-system'), local('SF Pro Text');
        }
        
        @font-face {
            font-family: 'SF Pro Display';
            src: local('-apple-system'), local('SF Pro Display');
        }

        :root {
            /* Theme Colors */
            --system-background: #000000;
            --secondary-background: #131313;
            --tertiary-background: #1b1b1b;
            --primary-text: #FFFFFF;
            --secondary-text: #B0B0B5;
            --tertiary-text: #808080;
            --separator: rgba(255, 255, 255, 0.1);
            --accent-color: #1ab8f7;
            --tab-bar-background: #000000;
            
            /* Layout Constants */
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
            --nav-height: 52px; /* Increased from 44px */
            --tab-height: 56px; /* Increased from 49px */
        }

        [data-theme="binance"] {
            --system-background: #121212; /* Dark background */
            --secondary-background: #1E1E1E; /* Slightly lighter dark background */
            --tertiary-background: #2A2A2A; /* Card background */
            --primary-text: #FFFFFF; /* White text */
            --secondary-text: #B0B0B5; /* Light gray text */
            --tertiary-text: #808080; /* Gray text */
            --separator: rgba(255, 255, 255, 0.1); /* Light separator */
            --accent-color: #F0B90B; /* Binance yellow */
            --tab-bar-background: #1E1E1E; /* Dark tab bar */
        }

        [data-theme="dark"] .current-value {
            color: white; /* White text for dark theme */
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }

        body {
            background: var(--system-background);
            color: var(--primary-text);
            padding-top: var(--safe-top);
            padding-bottom: calc(var(--tab-height) + var(--safe-bottom) + 20px); /* Increased padding */
            overscroll-behavior-y: contain;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2); /* Added light shadow to all text */
        }

        /* Pull to Refresh */
        .refresh-spinner {
            display: none;
            position: fixed;
            top: calc(var(--safe-top) + 10px);
            left: 50%;
            transform: translateX(-50%);
            z-index: 1001;
            color: var(--accent-color);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: translateX(-50%) rotate(0deg); }
            100% { transform: translateX(-50%) rotate(360deg); }
        }

        .refresh-spinner.active {
            display: block;
        }

        /* Action Sheet */
        .action-sheet {
            display: none; /* Initially hidden */
            position: fixed; /* Fixed position for overlay */
            bottom: 0; /* Align to the bottom */
            left: 0; /* Align to the left */
            right: 0; /* Align to the right */
            background: var(--secondary-background);
            border-radius: 15px 15px 0 0;
            padding: 16px;
            z-index: 2000;
            transform: translateY(100%); /* Start off-screen */
            transition: transform 0.3s ease, opacity 0.3s ease; /* Transition for smooth appearance */
            opacity: 0; /* Start fully transparent */
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); /* Subtle shadow */
        }

        .action-sheet.active {
            display: block; /* Show when active */
            transform: translateY(0); /* Move into view */
            opacity: 1; /* Fully visible */
        }

        .action-sheet-backdrop {
            display: none; /* Initially hidden */
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5); /* Semi-transparent background */
            z-index: 1999; /* Behind the action sheet */
            transition: opacity 0.3s ease; /* Transition for backdrop */
            opacity: 0; /* Start fully transparent */
        }

        .action-sheet-backdrop.active {
            display: block; /* Show when active */
            opacity: 1; /* Fully visible */
        }

        .action-sheet-title {
            font-size: 13px;
            color: var(--tertiary-text);
            text-align: center;
            margin-bottom: 16px;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease 0.1s;
        }

        .action-sheet.active .action-sheet-title {
            opacity: 1;
            transform: translateY(0);
        }

        .action-sheet-input {
            background: var(--tertiary-background);
            border: none;
            border-radius: 8px;
            padding: 12px;
            color: var(--primary-text);
            width: 100%;
            margin-bottom: 16px;
            font-size: 17px;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease 0.2s;
        }

        .action-sheet.active .action-sheet-input {
            opacity: 1;
            transform: translateY(0);
        }

        .action-sheet-button {
            background: var(--accent-color);
            color: white;
            padding: 16px;
            border: none;
            border-radius: 20px; /* Rounded corners */
            transition: background 0.3s ease;
        }

        .action-sheet-button:hover {
            background: #005BB5; /* Darker shade on hover */
        }

        .action-sheet-cancel {
            background: var(--tertiary-background);
            color: var(--accent-color);
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease 0.4s;
        }

        .action-sheet.active .action-sheet-cancel {
            opacity: 1;
            transform: translateY(0);
        }

        /* Tab Bar */
        .tab-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: calc(var(--tab-height) + var(--safe-bottom) + 10px); /* Increased height */
            background: var(--tab-bar-background);
            border-top: 0.5px solid var(--separator);
            display: flex;
            padding-bottom: var(--safe-bottom);
            z-index: 1000;
            padding: 10px 0; /* Added padding for better touch targets */
        }

        .tab-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--secondary-text);
            font-size: 10px;
            padding: 6px 0;
            cursor: pointer;
            transition: color 0.3s ease;
            border-radius: 15px; /* Increased from 13px */
            text-shadow: none; /* Ensure no shadow for tab items */
            box-shadow: none; /* Remove shadow from tab items */
        }

        .tab-item:hover {
            box-shadow: none; /* Ensure no shadow on hover */
        }

        .tab-item:active {
            box-shadow: none; /* Ensure no shadow when pressed */
        }

        .tab-item.active {
            color: var(--accent-color);
        }

        .tab-icon {
            font-size: 22px;
            margin-bottom: 4px;
            transition: transform 0.3s ease;
        }

        .tab-item:active .tab-icon {
            transform: scale(0.9);
        }

        /* Content Pages */
        .page {
            display: none;
            padding: 16px;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.3s ease, transform 0.3s ease;
            position: absolute; /* Allow overlapping pages */
            width: 100%; /* Ensure full width */
            height: 100%; /* Ensure full height */
            top: 0; /* Align to the top */
            left: 0; /* Align to the left */
        }

        .page.active {
            display: block; /* Ensure the active page is displayed */
            opacity: 1; /* Fully visible */
            transform: translateY(0); /* Original position */
            z-index: 1; /* Bring active page to the front */
        }

        .page:not(.active) {
            opacity: 0; /* Fully transparent */
            transform: translateY(20px); /* Slide down effect */
            z-index: 0; /* Send inactive pages to the back */
            pointer-events: none; /* Prevent interaction with inactive pages */
        }

        .price-card {
            background: var(--secondary-background);
            border-radius: 15px;
            padding: 24px;
            margin-bottom: 20px;
            transition: transform 0.3s ease;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); /* Subtle shadow */
        }

        .price-card:active {
            transform: scale(0.98);
        }

        .holdings-info {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--separator);
        }

        .settings-option {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--separator);
            transition: background-color 0.3s ease;
        }

        .settings-option:active {
            background-color: var(--tertiary-background);
        }

        .settings-option select {
            background: var(--tertiary-background);
            border: none;
            color: var(--accent-color);
            padding: 8px;
            border-radius: 8px;
            transition: transform 0.3s ease;
        }

        .settings-option select:focus {
            transform: scale(1.05);
        }

        .about-text {
            color: var(--secondary-text);
            line-height: 1.5;
            margin-top: 16px;
        }

        .chart-container {
            background: var(--secondary-background);
            border-radius: 13px;
            padding: 20px;
            height: 400px;
            margin-top: 16px;
            transition: transform 0.3s ease;
        }

        .chart-container:active {
            transform: scale(0.98);
        }

        /* Media Queries for Desktop Responsiveness */
        @media (min-width: 1024px) {
            body {
                padding-top: 20px; /* Adjust padding for desktop */
                padding-bottom: 20px; /* Adjust padding for desktop */
            }

            .tab-bar {
                height: 60px; /* Increase tab bar height for desktop */
            }

            .tab-item {
                font-size: 14px; /* Increase font size for desktop */
            }

            .price-card {
                padding: 30px; /* Increase padding for desktop */
            }

            .chart-container {
                height: 500px; /* Increase chart height for desktop */
            }

            .action-sheet {
                padding: 20px; /* Increase padding for action sheets on desktop */
            }

            .footer-text {
                font-size: 2rem; /* Increase footer text size for desktop */
            }

            .price-title {
                font-size: 1.5rem; /* Increase price title size for desktop */
            }

            .price-value {
                font-size: 2.5rem; /* Increase price value size for desktop */
            }

            /* Additional styles for desktop can be added here */
        }

        /* Add transition for buttons and cards */
        .action-sheet-button,
        .tab-item,
        .price-card {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        /* Add hover effect for buttons */
        .action-sheet-button:hover,
        .tab-item:hover {
            transform: scale(1.03); /* Slightly increase scale on hover */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2); /* Enhanced shadow on hover */
        }

        /* Add hover effect for price cards */
        .price-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
    </style>
</head>
<body>
    <!-- Pull to Refresh Spinner -->
    <div class="refresh-spinner">
        <i class="fas fa-sync-alt fa-spin"></i>
    </div>

    <!-- Action Sheet Backdrop -->
    <div class="action-sheet-backdrop" onclick="hideTimeframePopup()"></div>

    <!-- Edit Action Sheet -->
    <div class="action-sheet" id="editSheet">
        <div class="action-sheet-title">Enter BTC Amount</div>
        <input type="number" id="btcInput" class="action-sheet-input" placeholder="0.00000000" step="0.00000001">
        <button onclick="saveHoldings()" class="action-sheet-button" aria-label="Save BTC Amount">Save</button>
        <button onclick="hideEditSheet()" class="action-sheet-button action-sheet-cancel" aria-label="Cancel Edit">Cancel</button>
    </div>

    <!-- Price Page -->
    <div id="pricePage" class="page active">
        <div class="footer-text" style="font-weight: bold; text-align: left; margin: 20px 0; font-size: 1.5rem; padding-left: 16px;">Bitcoin Stash Tracker</div>
        <div class="price-card">
            <div class="price-title" style="font-size: 1.2rem;">Current Price</div>
            <div style="font-size: 2rem; display: flex; align-items: center;">
                <span id="currentPrice">$0.00</span>
                <span id="priceChange" style="margin-left: 10px; font-size: 1.2rem; display: inline;">(0.00%)</span>
            </div>
            <div class="holdings-info" id="holdingsInfo">
                <div class="price-title" style="font-size: 1.2rem;">Your Holdings</div>
                <div class="price-value" id="holdingsAmount" style="font-size: 2rem;">0 BTC</div>
            </div>
        </div>
        
        <!-- New Card for USD Value -->
        <div class="price-card" style="background: var(--secondary-background); margin-top: 16px;">
            <div class="price-title" style="font-size: 1.2rem; display: flex; align-items: center;">
                <i class="fas fa-money-bill-wave" style="color: rgb(31, 232, 247); margin-right: 8px;"></i> <!-- Updated cash icon -->
                Current Value
            </div>
            <div class="price-value current-value" id="holdingsValue" style="font-size: 2rem;">$0.00</div> <!-- USD value -->
        </div>

        <div class="chart-container">
            <canvas id="priceChart"></canvas>
        </div>

        <!-- Timeframe Selection Button -->
        <div style="display: flex; justify-content: center; margin-top: 16px; margin-bottom: 40px;">
            <button id="timeframeButton" onclick="showTimeframePopup()" style="background: var(--tertiary-background); color: var(--accent-color); border: none; padding: 8px 12px; border-radius: 15px; width: auto; font-size: 14px;">
                {currentTimeframe}
            </button>
        </div>
        
        <!-- Spacer for additional scrollable area -->
        <div style="height: 100px;"></div> <!-- Added spacer div -->
    </div>

    <!-- Timeframe Popup -->
    <div class="action-sheet" id="timeframeSheet">
        <div class="action-sheet-title">Select Timeframe</div>
        <button onclick="fetchHistoricalData('day'); updatePriceChange('day'); currentTimeframe = '24 Hours'; updateTimeframeButton(); hideTimeframePopup();" class="action-sheet-button" style="background-color: #1ab8f7;">24 Hours</button>
        <button onclick="fetchHistoricalData('hour'); updatePriceChange('hour'); currentTimeframe = '1 Hour'; updateTimeframeButton(); hideTimeframePopup();" class="action-sheet-button">1 Hour</button>
        <button onclick="fetchHistoricalData('lastYear'); updatePriceChange('lastYear'); currentTimeframe = 'Last Year'; updateTimeframeButton(); hideTimeframePopup();" class="action-sheet-button">Last Year</button>
        <button onclick="fetchHistoricalData('month'); updatePriceChange('month'); currentTimeframe = 'Past Month'; updateTimeframeButton(); hideTimeframePopup();" class="action-sheet-button">Past Month</button>
        <button onclick="hideTimeframePopup();" class="action-sheet-cancel" style="background: transparent; color: white; border: 1px solid white; border-radius: 15px; padding: 10px; width: 100%;">Cancel</button>
    </div>

    <!-- Settings Page -->
    <div id="settingsPage" class="page">
        <div class="footer-text" style="font-weight: bold; text-align: left; margin: 20px 0; font-size: 1.5rem; padding-left: 16px;">Settings</div>
        <div class="price-card">
            <div class="price-title">Settings</div>
            <div class="settings-option">
                <div>Theme</div>
                <select onchange="setTheme(this.value)">
                    <option value="dark">Dark</option>
                    <option value="binance">Binance</option>
                </select>
            </div>
            <div class="settings-option">
                <div>API Provider</div>
                <select onchange="setApiProvider(this.value)">
                    <option value="coincap">CoinCap</option>
                    <option value="coingecko">CoinGecko</option>
                </select>
            </div>
            <p class="about-text">
                A minimalist Bitcoin price tracker that helps you monitor your holdings in real-time. 
                Data provided by multiple free cryptocurrency APIs.
            </p>
        </div>
    </div>

    <!-- Tab Bar -->
    <div class="tab-bar">
        <div class="tab-item active" onclick="switchPage('pricePage', this)">
            <div class="tab-icon"><i class="fas fa-chart-line"></i></div>
            <div>Price</div>
        </div>
        <div class="tab-item" onclick="showEditSheet()">
            <div class="tab-icon"><i class="fas fa-pen"></i></div>
            <div>Edit</div>
        </div>
        <div class="tab-item" onclick="switchPage('settingsPage', this)">
            <div class="tab-icon"><i class="fas fa-cog"></i></div>
            <div>Settings</div>
        </div>
    </div>

    <button id="addToHomeScreen" style="display: none;">Add to Home Screen</button>

    <script>
        let currentTheme = localStorage.getItem('theme') || 'dark';
        let btcHoldings = localStorage.getItem('btcHoldings') || 0;
        let currentApiProvider = localStorage.getItem('apiProvider') || 'coincap';
        let lastY = 0;
        let refreshing = false;
        let deferredPrompt;
        let lastRefreshTime = 0; // Track the last refresh time
        const refreshCooldown = 60000; // 1 minute cooldown
        let chartLineColor = '#00FF00'; // Default to green for dark theme
        let lastApiCallTime = 0; // Track the last API call time
        const apiCallCooldown = 60000; // 1 minute cooldown for API calls
        let currentTimeframe = '24 Hours'; // Default timeframe
        let manualRefreshAllowed = true; // Flag to track manual refresh
        let apiProviders = ['coincap', 'coingecko']; // List of API providers with CoinCap first
        let currentApiProviderIndex = apiProviders.indexOf(currentApiProvider); // Get the index of the current provider

        document.documentElement.setAttribute('data-theme', currentTheme);

        // Pull to refresh functionality
        document.addEventListener('touchstart', e => {
            lastY = e.touches[0].clientY;
        });

        document.addEventListener('touchmove', e => {
            const y = e.touches[0].clientY;
            const scrollTop = document.documentElement.scrollTop;
            
            // Check if we are at the top of the page and if the cooldown period has passed
            if (scrollTop === 0 && y > lastY && !refreshing && (Date.now() - lastRefreshTime) > refreshCooldown) {
                if (manualRefreshAllowed) {
                    document.querySelector('.refresh-spinner').classList.add('active');
                    refreshing = true;
                    fetchPrice(true);
                    lastRefreshTime = Date.now(); // Update the last refresh time
                    manualRefreshAllowed = false; // Disable further manual refreshes until the next auto refresh
                }
            }
            lastY = y;
        });

        function setTheme(theme) {
            currentTheme = theme;
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            
            // Update the theme selection dropdown
            const themeSelect = document.querySelector('select[onchange="setTheme(this.value)"]');
            if (themeSelect) {
                themeSelect.value = theme; // Set the dropdown to the current theme
            }

            // Update the chart line color based on the new theme
            chartLineColor = (currentTheme === 'binance') ? '#00FF00' : '#00FF00'; // Keep green for both themes
            chart.data.datasets[0].borderColor = chartLineColor; // Update the chart line color
            chart.update(); // Refresh the chart
        }

        function setApiProvider(provider) {
            currentApiProvider = provider;
            localStorage.setItem('apiProvider', provider);
            fetchPrice(true);
        }

        function showEditSheet() {
            document.querySelector('.action-sheet-backdrop').classList.add('active');
            const actionSheet = document.querySelector('.action-sheet');
            actionSheet.classList.add('active');
            setTimeout(() => {
                actionSheet.style.display = 'block'; // Ensure it's displayed after transition
            }, 0); // Delay to allow CSS transition to take effect
            document.getElementById('btcInput').focus();
        }

        function hideEditSheet() {
            const actionSheet = document.querySelector('.action-sheet');
            actionSheet.classList.remove('active');
            document.querySelector('.action-sheet-backdrop').classList.remove('active');
            setTimeout(() => {
                actionSheet.style.display = 'none'; // Hide after transition
            }, 300); // Match the duration of the CSS transition
        }

        function switchPage(pageId, tabElement) {
            const currentPage = document.querySelector('.page.active');
            const newPage = document.getElementById(pageId);

            if (currentPage !== newPage) {
                currentPage.classList.remove('active'); // Fade out current page
                newPage.classList.add('active'); // Fade in new page
                tabElement.classList.add('active'); // Activate the new tab

                // Deactivate other tabs
                document.querySelectorAll('.tab-item').forEach(tab => {
                    if (tab !== tabElement) {
                        tab.classList.remove('active');
                    }
                });
            }
        }

        function saveHoldings() {
            const amount = document.getElementById('btcInput').value;
            btcHoldings = amount;
            localStorage.setItem('btcHoldings', amount);
            updateHoldingsDisplay();
            hideEditSheet();
            switchPage('pricePage', document.querySelector('.tab-item'));
        }

        function updateHoldingsDisplay() {
            const holdings = parseFloat(btcHoldings);
            const price = parseFloat(document.getElementById('currentPrice').textContent.replace('$', '').replace(',', '')) || 0;
            const value = holdings * price;
            
            // Update holdings amount and value only if holdings are greater than 0
            if (holdings > 0) {
                document.getElementById('holdingsAmount').textContent = `${holdings} BTC`;
                document.getElementById('holdingsValue').textContent = `$${value.toLocaleString()}`;
                document.getElementById('holdingsInfo').style.display = 'block'; // Show holdings info
            } else {
                document.getElementById('holdingsAmount').textContent = '';
                document.getElementById('holdingsValue').textContent = '$0.00';
                document.getElementById('holdingsInfo').style.display = 'none'; // Hide holdings info
            }
        }

        // Initialize Chart
        const ctx = document.getElementById('priceChart').getContext('2d');
        const priceData = {
            labels: [],
            datasets: [{
                label: 'BTC/USDT',
                data: [],
                borderColor: chartLineColor,
                borderWidth: 2,
                fill: false,
                tension: 0.4,
                pointRadius: 0 // Remove points on the line
            }]
        };

        const chartConfig = {
            type: 'line',
            data: priceData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    x: {
                        grid: {
                            color: currentTheme === 'binance' ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
                        },
                        ticks: {
                            color: currentTheme === 'binance' ? '#FFFFFF' : '#808080'
                        }
                    },
                    y: {
                        grid: {
                            color: currentTheme === 'binance' ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
                        },
                        ticks: {
                            color: currentTheme === 'binance' ? '#FFFFFF' : '#808080'
                        }
                    }
                }
            }
        };

        const chart = new Chart(ctx, chartConfig);

        function setTimeframe(timeframe) {
            currentTimeframe = timeframe; // Update the current timeframe
            localStorage.setItem('timeframe', timeframe); // Store the selected timeframe
            fetchHistoricalData(currentTimeframe); // Fetch historical data for the selected timeframe
        }

        async function fetchHistoricalData(timeframe) {
            return new Promise(async (resolve, reject) => {
                let url;
                const now = Math.floor(Date.now() / 1000);
                
                switch (timeframe) {
                    case 'hour':
                        const oneHourAgo = now - 3600;
                        url = `https://api.coingecko.com/api/v3/coins/bitcoin/market_chart/range?vs_currency=usd&from=${oneHourAgo}&to=${now}`;
                        break;
                    case 'day':
                        const oneDayAgo = now - 86400;
                        url = `https://api.coingecko.com/api/v3/coins/bitcoin/market_chart/range?vs_currency=usd&from=${oneDayAgo}&to=${now}`;
                        break;
                    case 'lastYear':
                        const oneYearAgo = now - 31536000; // 1 year ago in seconds
                        url = `https://api.coingecko.com/api/v3/coins/bitcoin/market_chart/range?vs_currency=usd&from=${oneYearAgo}&to=${now}`;
                        break;
                    case 'month':
                        const oneMonthAgo = now - 2592000; // 30 days ago in seconds
                        url = `https://api.coingecko.com/api/v3/coins/bitcoin/market_chart/range?vs_currency=usd&from=${oneMonthAgo}&to=${now}`;
                        break;
                    default:
                        reject('Invalid timeframe');
                        return;
                }

                try {
                    const response = await fetch(url);
                    if (!response.ok) throw new Error('Network response was not ok');
                    const data = await response.json();
                    
                    // Clear existing data
                    priceData.labels = [];
                    priceData.datasets[0].data = [];
                    
                    // Process historical data
                    data.prices.forEach(([timestamp, price]) => {
                        const date = new Date(timestamp);
                        priceData.labels.push(date.toLocaleTimeString());
                        priceData.datasets[0].data.push(price);
                    });
                    
                    chart.update();
                    resolve(); // Resolve the promise after data is processed
                } catch (error) {
                    console.error('Error fetching historical data:', error);
                    // Disable timeframe selection and reset text on error
                    disableTimeframeSelection();
                    reject(error); // Reject the promise on error
                }
            });
        }

        async function fetchPrice(isRefresh = false) {
            const currentTime = Date.now();
            
            // Check if the cooldown period has passed for automatic refresh
            if (currentTime - lastApiCallTime < apiCallCooldown) {
                console.warn('API call limit reached. Please wait before making another request.');
                return; // Exit the function if the limit is reached
            }

            try {
                let response;
                if (currentApiProvider === 'coincap') {
                    response = await fetch('https://api.coincap.io/v2/assets/bitcoin');
                } else if (currentApiProvider === 'coingecko') {
                    response = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd');
                } else {
                    throw new Error('Invalid API provider');
                }

                if (!response.ok) {
                    if (response.status === 429) { // Rate limit error
                        console.warn('Rate limit reached for ' + currentApiProvider + '. Switching to the next provider.');
                        switchApiProvider(); // Switch to the next API provider
                        return; // Exit the function to retry with the new provider
                    }
                    throw new Error('Network response was not ok');
                }

                const data = currentApiProvider === 'coincap' ? await response.json() : await response.json();
                const price = currentApiProvider === 'coincap' ? data.data.priceUsd : data.bitcoin.usd;

                document.getElementById('currentPrice').textContent = `$${parseFloat(price).toLocaleString()}`;
                updateHoldingsDisplay();
                await updatePriceChange(currentTimeframe); // Use the current timeframe for price change
                
                const now = new Date();
                
                // Add new price to chart
                priceData.labels.push(now.toLocaleTimeString());
                priceData.datasets[0].data.push(price);
                
                // Keep only last hour of data
                const oneHourAgo = now.getTime() - 3600000;
                const cutoffIndex = priceData.labels.findIndex(label => {
                    return new Date('1/1/2023 ' + label).getTime() > oneHourAgo;
                });
                
                if (cutoffIndex > 0) {
                    priceData.labels = priceData.labels.slice(cutoffIndex);
                    priceData.datasets[0].data = priceData.datasets[0].data.slice(cutoffIndex);
                }
                
                chart.update();

                if (isRefresh) {
                    setTimeout(() => {
                        document.querySelector('.refresh-spinner').classList.remove('active');
                        refreshing = false;
                    }, 500);
                }

                lastApiCallTime = currentTime; // Update the last API call time
                lastRefreshTime = currentTime; // Update the last refresh time
                manualRefreshAllowed = true; // Allow manual refresh again after successful fetch
            } catch (error) {
                console.error('Error fetching price:', error);
                if (isRefresh) {
                    document.querySelector('.refresh-spinner').classList.remove('active');
                    refreshing = false; // Allow refreshing again after an error
                }
                // Disable timeframe selection and reset text on error
                disableTimeframeSelection();
            }
        }

        function switchApiProvider() {
            // Move to the next API provider
            currentApiProviderIndex = (currentApiProviderIndex + 1) % apiProviders.length; // Cycle through the providers
            currentApiProvider = apiProviders[currentApiProviderIndex]; // Update the current provider
            localStorage.setItem('apiProvider', currentApiProvider); // Store the new provider
            fetchPrice(true); // Retry fetching the price with the new provider
        }

        async function updatePriceChange(timeframe) {
            try {
                const now = Math.floor(Date.now() / 1000);
                let fromTime;

                switch (timeframe) {
                    case 'hour':
                        fromTime = now - 3600; // 1 hour ago
                        break;
                    case 'day':
                        fromTime = now - 86400; // 24 hours ago
                        break;
                    case 'lastYear':
                        fromTime = now - 31536000; // 1 year ago in seconds
                        break;
                    case 'month':
                        fromTime = now - 2592000; // 30 days ago in seconds
                        break;
                    default:
                        return;
                }

                const url = `https://api.coingecko.com/api/v3/coins/bitcoin/market_chart/range?vs_currency=usd&from=${fromTime}&to=${now}`;
                const response = await fetch(url);
                const data = await response.json();
                const prices = data.prices;

                if (prices.length > 0) {
                    const initialPrice = prices[0][1]; // Price at the start of the timeframe
                    const currentPrice = prices[prices.length - 1][1]; // Current price

                    const priceChange = ((currentPrice - initialPrice) / initialPrice) * 100; // Calculate percentage change
                    const priceChangeElement = document.getElementById('priceChange');

                    priceChangeElement.textContent = `(${priceChange.toFixed(2)}%)`; // Display percentage change

                    // Change color based on price change
                    if (priceChange < 0) {
                        priceChangeElement.style.color = 'red'; // Down
                    } else {
                        priceChangeElement.style.color = chartLineColor; // Up, match chart line color
                    }
                } else {
                    // Handle case where no price data is available
                    document.getElementById('priceChange').textContent = '(N/A)';
                    document.getElementById('priceChange').style.color = 'gray'; // Neutral color
                }
            } catch (error) {
                console.error('Error fetching historical price data:', error);
            }
        }

        function disableTimeframeSelection() {
            // Disable the timeframe selection dropdown
            const timeframeSelect = document.querySelector('select[onchange="setTimeframe(this.value)"]');
            if (timeframeSelect) {
                timeframeSelect.disabled = true; // Disable the dropdown
                timeframeSelect.value = ''; // Reset the selected value
            }
            // Optionally, reset the displayed timeframe text
            document.getElementById('timeframeButton').textContent = 'Data Unavailable'; // Update button text
        }

        // Initialize historical data fetch on load
        fetchHistoricalData(currentTimeframe).then(() => {
            updatePriceChange(currentTimeframe); // Ensure this reflects the selected timeframe
            fetchPrice(); // Fetch the current price after loading historical data
        }).catch(error => {
            console.error('Error during initial data fetch:', error);
            // Attempt to fetch the current price even if historical data fetch fails
            fetchPrice(); // Fetch the current price regardless of historical data fetch success
        });

        // Register service worker for PWA functionality
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js')
                    .then(registration => {
                        console.log('Service Worker registered with scope:', registration.scope);
                    })
                    .catch(error => {
                        console.error('Service Worker registration failed:', error);
                    });
            });
        }

        window.addEventListener('beforeinstallprompt', (e) => {
            // Prevent the mini-info bar from appearing on mobile
            e.preventDefault();
            // Stash the event so it can be triggered later
            deferredPrompt = e;
            // Update UI to notify the user they can add to home screen
            document.getElementById('addToHomeScreen').style.display = 'block';
        });

        document.getElementById('addToHomeScreen').addEventListener('click', (e) => {
            // Hide the button
            document.getElementById('addToHomeScreen').style.display = 'none';
            // Show the prompt
            deferredPrompt.prompt();
            // Wait for the user to respond to the prompt
            deferredPrompt.userChoice.then((choiceResult) => {
                if (choiceResult.outcome === 'accepted') {
                    console.log('User accepted the A2HS prompt');
                } else {
                    console.log('User dismissed the A2HS prompt');
                }
                deferredPrompt = null;
            });
        });

        function showTimeframePopup() {
            document.querySelector('.action-sheet-backdrop').classList.add('active');
            document.getElementById('timeframeSheet').classList.add('active');
        }

        function hideTimeframePopup() {
            if (document.getElementById('timeframeSheet').classList.contains('active')) {
                document.querySelector('.action-sheet-backdrop').classList.remove('active');
                document.getElementById('timeframeSheet').classList.remove('active');
            }
        }

        function updateTimeframeButton() {
            document.getElementById('timeframeButton').textContent = currentTimeframe; // Update button text
        }

        document.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme') || 'dark'; // Default to dark if no theme is saved
            setTheme(savedTheme); // Set the theme based on saved value

            // Fetch historical data for the last 24 hours and update price change on startup
            fetchHistoricalData('day').then(() => {
                updatePriceChange('day'); // Update price change after fetching historical data
                updateTimeframeButton(); // Set the initial button text
            });
        });
    </script>
</body>
</html>
